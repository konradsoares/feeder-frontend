<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Feeder Control</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h2 { margin-bottom: 10px; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; }
    input[type="time"] { padding: 5px; margin-right: 10px; }

    table {
      width: 300px;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #f0f0f0;
    }

    .delete-btn {
      background-color: red;
      color: white;
      padding: 5px 10px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h2>Feeder Control Panel</h2>

  <div id="status">Loading status...</div>

  <button onclick="toggleMode()">Switch Mode</button>
  <button onclick="triggerManual()" id="manualBtn" disabled>Open/Close Feeder</button>

  <hr>
  <h3>Scheduled Feeding</h3>

  <form onsubmit="addSchedule(event)">
    <input type="time" id="scheduleTime" required>
    <button type="submit">Add Schedule</button>
  </form>

  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="scheduleTableBody">
      <!-- Rows inserted here -->
    </tbody>
  </table>

  <script>
    const apiBase = 'https://feeder-backend-production.up.railway.app/api';

    async function fetchStatus() {
      try {
        const res = await fetch(`${apiBase}/status`);
        const data = await res.json();
        document.getElementById('status').innerText =
          `Time: ${data.time} | Mode: ${data.mode} | Feeder: ${data.feeder}`;
        document.getElementById('manualBtn').disabled = (data.mode === 'auto');
      } catch (err) {
        document.getElementById('status').innerText = "Error loading status";
      }
    }

    async function toggleMode() {
      await fetch(`${apiBase}/mode`, { method: 'POST' });
      fetchStatus();
    }

    async function triggerManual() {
      await fetch(`${apiBase}/manual`, { method: 'POST' });
      fetchStatus();
    }

    async function fetchSchedules() {
      const res = await fetch(`${apiBase}/schedules`);
      const schedules = await res.json();
      const tbody = document.getElementById('scheduleTableBody');
      tbody.innerHTML = '';

      schedules.forEach(s => {
        const row = document.createElement('tr');

        const timeStr = `${String(s.hour).padStart(2, '0')}:${String(s.minute).padStart(2, '0')}`;
        const timeCell = document.createElement('td');
        timeCell.textContent = timeStr;

        const actionCell = document.createElement('td');
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.className = 'delete-btn';
        deleteBtn.onclick = () => deleteSchedule(s._id);

        actionCell.appendChild(deleteBtn);
        row.appendChild(timeCell);
        row.appendChild(actionCell);

        tbody.appendChild(row);
      });
    }

    async function addSchedule(e) {
      e.preventDefault();
      const time = document.getElementById('scheduleTime').value;
      const [hourStr, minuteStr] = time.split(':');
      const hour = parseInt(hourStr);
      const minute = parseInt(minuteStr);

      await fetch(`${apiBase}/schedules`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hour, minute })
      });

      document.getElementById('scheduleTime').value = '';
      fetchSchedules();
    }

    async function deleteSchedule(id) {
      await fetch(`${apiBase}/schedules/${id}`, { method: 'DELETE' });
      fetchSchedules();
    }

    // Load everything initially
    fetchStatus();
    fetchSchedules();
    setInterval(fetchStatus, 60000); // Update status every 60s
  </script>
</body>
</html>
